// frontend/src/pages/ProfilePage.tsx
import React, { useState, useEffect } from "react";
import { useAuth } from "../hooks/useAuth";
import { useNavigate } from "react-router-dom";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/Input";
import { Alert } from "../components/ui/Alert";
import {
  useMyProfile,
  useMyRegistrations,
  useUpdateProfile,
  useDeleteUser,
} from "../hooks/api/useUsers";
import { useCancelRegistration } from "../hooks/api/useRegistration";

// ----------- SVG Icon Components ----------- //

const UserIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
  </svg>
);

const CalendarIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
  </svg>
);

const CreditCardIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
  </svg>
);

const SettingsIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
  </svg>
);

const BellIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-5 5v-5zM10.5 17H15l-5 5v-5zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);

const ShieldIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
  </svg>
);

const LinkIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
  </svg>
);

const CloudUploadIcon = () => (
  <svg className="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
  </svg>
);

const DownloadIcon = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  </svg>
);

const EyeIcon = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
  </svg>
);



// Section Header Component
const SectionHeader = ({ icon, title }: { icon: React.ReactNode; title: string }) => (
  <div className="flex items-center mb-6">
    {icon}
    <h3 className="text-xl font-bold text-gray-900">{title}</h3>
  </div>
);

import { Badge } from "../components/ui/Badge";
import type { BadgeVariant } from "../components/ui/Badge";
import { Tabs } from "../components/ui/Tabs";
import { Card } from "../components/ui/Card";
import { ImageUpload } from "../components/ui/ImageUpload";

// ... (Icons remain the same)

// Event Status Badge Component
const StatusBadge = ({ status }: { status: string }) => {
  const configs: Record<string, { variant: BadgeVariant; label: string }> = {
    CONFIRMED: { variant: "success", label: "Confirmed" },
    WAITLISTED: { variant: "warning", label: "Waitlisted" },
    PENDING: { variant: "warning", label: "Pending" },
    CANCELLED: { variant: "neutral", label: "Cancelled" },
    ATTENDED: { variant: "info", label: "Attended" },
  };

  const config = configs[status] || { variant: "neutral", label: "Unknown" };

  return <Badge variant={config.variant}>{config.label}</Badge>;
};

interface ProfileFormData {
  firstName: string;
  lastName: string;
  phone: string;
  university: string;
  nationality: string;
  chapter: string;
  bio: string;
  telegram: string;
  instagram: string;
  emergencyContactName: string;
  emergencyContactPhone: string;
}

interface NotificationSettings {
  emailEvents: boolean;
  emailReminders: boolean;
  emailNewsletter: boolean;
  emailPromotions: boolean;
  pushEvents: boolean;
  pushReminders: boolean;
  pushUpdates: boolean;
  smsReminders: boolean;
}

interface PrivacySettings {
  profileVisible: boolean;
  showEmail: boolean;
  showPhone: boolean;
  showUniversity: boolean;
  allowMessages: boolean;
}

interface Registration {
  id: string;
  status: string;
  event: {
    id: string;
    title: string;
    startDate: string;
    location: string;
    imageUrl?: string;
  };
}

const ProfilePage: React.FC = () => {
  const { isSignedIn, isLoaded, user, logout } = useAuth();
  const navigate = useNavigate();

  // State Management
  const [activeTab, setActiveTab] = useState<'overview' | 'events' | 'settings'>('overview');
  const [isEditingProfile, setIsEditingProfile] = useState(false);
  const [isChangingPhoto, setIsChangingPhoto] = useState(false);
  const [isUploadingPhoto, setIsUploadingPhoto] = useState(false);
  const [eventFilter, setEventFilter] = useState<'all' | 'upcoming' | 'past' | 'cancelled'>('all');
  const [showNotificationSettings, setShowNotificationSettings] = useState(false);
  const [showPrivacySettings, setShowPrivacySettings] = useState(false);
  const [showDeleteAccount, setShowDeleteAccount] = useState(false);

  // Success/Error states
  const [updateSuccess, setUpdateSuccess] = useState(false);
  const [updateError, setUpdateError] = useState<string | null>(null);

  // ESN Card Management
  const [esnCardNumber, setEsnCardNumber] = useState("");
  const [esnCardExpiry, setEsnCardExpiry] = useState("");
  const [isSubmittingCard, setIsSubmittingCard] = useState(false);

  // Profile form state
  const [profileData, setProfileData] = useState<ProfileFormData>({
    firstName: "",
    lastName: "",
    phone: "",
    university: "",
    nationality: "",
    chapter: "",
    bio: "",
    telegram: "",
    instagram: "",
    emergencyContactName: "",
    emergencyContactPhone: "",
  });

  // Notification preferences
  const [notifications, setNotifications] = useState<NotificationSettings>({
    emailEvents: true,
    emailReminders: true,
    emailNewsletter: false,
    emailPromotions: false,
    pushEvents: true,
    pushReminders: true,
    pushUpdates: true,
    smsReminders: false,
  });

  // Privacy settings
  const [privacy, setPrivacy] = useState<PrivacySettings>({
    profileVisible: true,
    showEmail: false,
    showPhone: false,
    showUniversity: true,
    allowMessages: true,
  });

  // GraphQL Queries and Mutations
  const { user: dbUser, loading: profileLoading, refetch: refetchProfile } = useMyProfile({
    skip: !isSignedIn,
  });

  const { registrations: allRegistrations, loading: registrationsLoading, error: registrationsError, refetch: refetchRegistrations } = useMyRegistrations({
    skip: !isSignedIn,
  });

  const { updateProfile: updateUserProfile, loading: updating } = useUpdateProfile();
  const { cancelRegistration, loading: cancellingRegistration } = useCancelRegistration();

  // Initialize form data when user data loads
  useEffect(() => {
    if (dbUser) {
      setProfileData({
        firstName: dbUser.firstName || "",
        lastName: dbUser.lastName || "",
        phone: dbUser.phone || "",
        university: dbUser.university || "",
        nationality: dbUser.nationality || "",
        chapter: dbUser.chapter || "",
        bio: dbUser.bio || "",
        telegram: dbUser.telegram || "",
        instagram: dbUser.instagram || "",
        emergencyContactName: dbUser.emergencyContactName || "",
        emergencyContactPhone: dbUser.emergencyContactPhone || "",
      });

      // Load notification settings from user metadata (if stored in DB, otherwise keep using Auth0 or move to DB)
      // Assuming notifications/privacy are also in DB user now or still in Auth0 metadata?
      // The schema has NotificationSettings relation. Let's assume we should use DB if available.
      // For now, let's stick to fixing the profile fields first.
    }
  }, [dbUser]);

  // Handle profile update
  const handleProfileUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    setUpdateError(null);

    try {
      // Update backend through GraphQL only
      await updateUserProfile({
        variables: {
          updateUserInput: {
            firstName: profileData.firstName,
            lastName: profileData.lastName,
            phone: profileData.phone,
            university: profileData.university,
            nationality: profileData.nationality,
            chapter: profileData.chapter,
            bio: profileData.bio,
            telegram: profileData.telegram,
            instagram: profileData.instagram,
            emergencyContactName: profileData.emergencyContactName,
            emergencyContactPhone: profileData.emergencyContactPhone,
          },
        },
      });

      // Update backend through GraphQL
      await updateUserProfile({
        variables: {
          updateUserInput: {
            firstName: profileData.firstName,
            lastName: profileData.lastName,
            phone: profileData.phone,
            university: profileData.university,
            nationality: profileData.nationality,
          },
        },
      });

      setIsEditingProfile(false);
      setUpdateSuccess(true);
      setTimeout(() => setUpdateSuccess(false), 3000);
      refetchProfile();
    } catch (error) {
      console.error("Profile update error:", error);
      setUpdateError("Failed to update profile. Please try again.");
    }
  };

  // Handle photo upload
  const handlePhotoUpload = async (file: File) => {
    setIsUploadingPhoto(true);
    setUpdateError(null);

    try {
      // Create FormData for file upload
      const formData = new FormData();
      formData.append('file', file);

      // Upload to a service like Cloudinary or your backend
      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        throw new Error('Upload failed');
      }

      const data = await response.json();
      const imageUrl = data.url;

      // Update user with new avatar URL
      await updateUserProfile({
        variables: {
          updateUserInput: {
            avatar: imageUrl,
          },
        },
      });

      setIsChangingPhoto(false);
      setUpdateSuccess(true);
      setTimeout(() => setUpdateSuccess(false), 3000);
    } catch (error) {
      console.error("Photo upload error:", error);
      setUpdateError("Failed to upload photo. Please try again.");
    } finally {
      setIsUploadingPhoto(false);
    }
  };

  // Handle ESN card submission
  const handleEsnCardSubmit = async () => {
    if (!esnCardNumber.trim()) {
      setUpdateError("Please enter a valid ESN card number");
      return;
    }

    setIsSubmittingCard(true);
    setUpdateError(null);

    try {
      // Update ESN card info via backend mutation if available
      // Skipping direct user.update call.

      setEsnCardNumber("");
      setEsnCardExpiry("");
      setUpdateSuccess(true);
      setTimeout(() => setUpdateSuccess(false), 3000);
    } catch (error) {
      console.error("ESN card update error:", error);
      setUpdateError("Failed to add ESN card. Please try again.");
    } finally {
      setIsSubmittingCard(false);
    }
  };

  // Handle notification settings update
  const handleNotificationUpdate = async () => {
    try {
      // Update notification settings via backend mutation if available
      // Skipping direct user.update call.

      setShowNotificationSettings(false);
      setUpdateSuccess(true);
      setTimeout(() => setUpdateSuccess(false), 3000);
    } catch (error) {
      console.error("Notification settings update error:", error);
      setUpdateError("Failed to update notification settings.");
    }
  };

  // Handle privacy settings update
  const handlePrivacyUpdate = async () => {
    try {
      // Update privacy settings via backend mutation if available
      // Skipping direct user.update call.

      setShowPrivacySettings(false);
      setUpdateSuccess(true);
      setTimeout(() => setUpdateSuccess(false), 3000);
    } catch (error) {
      console.error("Privacy settings update error:", error);
      setUpdateError("Failed to update privacy settings.");
    }
  };

  // Export user data
  const handleExportData = () => {
    const userData = {
      profile: profileData,
      registrations: allRegistrations,
      notifications,
      privacy,
      createdAt: user?.createdAt,
      lastSignInAt: user?.lastSignInAt,
    };

    const dataStr = JSON.stringify(userData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `esn-profile-${user?.firstName}-${user?.lastName}-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    URL.revokeObjectURL(url);
  };

  // Generate calendar link
  const getCalendarLink = () => {
    const baseUrl = window.location.origin;
    return `${baseUrl}/api/calendar/${user?.id}`;
  };

  // Handle logout
  const handleLogout = async () => {
    try {
      logout({ logoutParams: { returnTo: window.location.origin } });
      navigate("/");
    } catch (error) {
      console.error("Logout error:", error);
    }
  };

  const { deleteUser } = useDeleteUser();

  // Handle account deletion
  const handleDeleteAccount = async () => {
    if (window.confirm("Are you sure you want to delete your account? This action cannot be undone.")) {
      try {
        await deleteUser();
        logout({ logoutParams: { returnTo: window.location.origin } });
        navigate("/");
      } catch (error) {
        console.error("Account deletion error:", error);
        setUpdateError("Failed to delete account. Please contact support.");
      }
    }
  };

  // Filter registrations based on selected filter
  const getFilteredRegistrations = () => {
    const registrations = allRegistrations;
    const now = new Date();

    switch (eventFilter) {
      case 'upcoming':
        return registrations.filter((r: Registration) => new Date(r.event.startDate) > now && r.status !== 'CANCELLED');
      case 'past':
        return registrations.filter((r: Registration) => new Date(r.event.startDate) <= now || r.status === 'ATTENDED');
      case 'cancelled':
        return registrations.filter((r: Registration) => r.status === 'CANCELLED');
      default:
        return registrations;
    }
  };

  // Loading state
  if (!isLoaded || profileLoading) {
    return (
      <div className="bg-gray-50 min-h-screen font-sans">
        <div className="container mx-auto p-4 md:p-8">
          <div className="bg-white rounded-2xl shadow-xl overflow-hidden animate-pulse">
            <div className="h-48 bg-gray-200"></div>
            <div className="p-6 md:p-10">
              <div className="space-y-4">
                <div className="h-8 bg-gray-200 rounded w-1/2"></div>
                <div className="h-6 bg-gray-200 rounded w-1/3"></div>
                <div className="h-32 bg-gray-200 rounded"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Not signed in state
  if (!isSignedIn) {
    return (
      <div className="bg-gray-50 min-h-screen font-sans flex items-center justify-center">
        <div className="max-w-md w-full text-center">
          <div className="bg-white p-8 rounded-2xl shadow-xl">
            <div className="text-6xl mb-4">ðŸ”’</div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Sign In Required</h2>
            <p className="text-gray-600 mb-6">You need to sign in to view your profile.</p>
            <Button onClick={() => navigate("/sign-in")} className="w-full">Sign In</Button>
          </div>
        </div>
      </div>
    );
  }

  const registrations = getFilteredRegistrations();
  // allRegistrations is already defined from hook
  const memberSince = user?.createdAt ? new Date(user.createdAt).getFullYear() : new Date().getFullYear();

  return (
    <div className="bg-gray-50 min-h-screen font-sans">
      {/* Success Message */}
      {updateSuccess && (
        <div className="fixed top-4 right-4 z-50 max-w-sm">
          <Alert
            type="success"
            title="Updated Successfully!"
            message="Your changes have been saved."
            onClose={() => setUpdateSuccess(false)}
          />
        </div>
      )}


      {/* Error Message */}
      {updateError && (
        <div className="fixed top-4 right-4 z-50 max-w-sm">
          <Alert
            type="error"
            title="Update Failed"
            message={updateError}
            onClose={() => setUpdateError(null)}
          />
        </div>
      )}

      <div className="container mx-auto p-4 md:p-8">
        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
          {/* Header with Profile Card */}
          {/* Header with Profile Card */}
          <div className="h-48 bg-gradient-to-r from-blue-500 to-blue-600 relative">
            <div className="absolute inset-0 bg-black bg-opacity-20"></div>
            <div className="absolute bottom-6 left-6 text-white">
              <div className="flex items-center gap-4">
                <div className="relative group">
                  <div className="w-20 h-20 bg-white bg-opacity-20 backdrop-blur-sm rounded-full flex items-center justify-center text-white font-bold text-2xl border-4 border-white shadow-lg overflow-hidden">
                    {dbUser?.avatar ? (
                      <img
                        src={dbUser.avatar}
                        alt="Profile"
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      dbUser?.firstName?.[0]?.toUpperCase() || "U"
                    )}
                  </div>
                  <button
                    onClick={() => setIsChangingPhoto(true)}
                    className="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    <svg
                      className="w-6 h-6 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                      />
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                  </button>
                </div>
                <div>
                  <h1 className="text-3xl md:text-4xl font-extrabold leading-tight">
                    {dbUser?.firstName} {dbUser?.lastName}
                  </h1>
                  <p className="text-xl opacity-90">
                    ESN Member since {memberSince}
                  </p>
                  {dbUser?.university && (
                    <p className="text-lg opacity-75">
                      {dbUser.university}
                    </p>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Photo Upload Modal */}
          {isChangingPhoto && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6">
                <h3 className="text-xl font-bold mb-4">Update Profile Photo</h3>
                <ImageUpload
                  value={dbUser?.avatar}
                  onChange={async (url) => {
                    await updateUserProfile({
                      variables: {
                        updateUserInput: {
                          avatar: url,
                        },
                      },
                    });
                    setIsChangingPhoto(false);
                    setUpdateSuccess(true);
                    setTimeout(() => setUpdateSuccess(false), 3000);
                  }}
                  onUpload={async (file) => {
                    const formData = new FormData();
                    formData.append('file', file);
                    const response = await fetch('/api/upload', {
                      method: 'POST',
                      body: formData,
                    });
                    if (!response.ok) throw new Error('Upload failed');
                    const data = await response.json();
                    return data.url;
                  }}
                />
                <div className="mt-4 flex justify-end">
                  <Button
                    variant="secondary"
                    onClick={() => setIsChangingPhoto(false)}
                  >
                    Cancel
                  </Button>
                </div>
              </div>
            </div>
          )}

          {/* Navigation Tabs */}
          <div className="px-6 md:px-10">
            <Tabs
              tabs={[
                { id: "overview", label: "Overview" },
                { id: "events", label: "Events", count: allRegistrations.length },
                { id: "settings", label: "Settings" },
              ]}
              activeTab={activeTab}
              onChange={(id) =>
                setActiveTab(id as "overview" | "events" | "settings")
              }
            />
          </div>

          <div className="p-6 md:p-10">
            {/* Overview Tab */}
            {activeTab === "overview" && (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
                {/* Left Column: Profile Details */}
                <div className="lg:col-span-2 space-y-8">
                  {/* User Information Section */}
                  <Card>
                    <SectionHeader
                      icon={<UserIcon />}
                      title="Personal Information"
                    />


                    <div className="grid md:grid-cols-2 gap-6 mb-6">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Email Address
                        </label>
                        <p className="text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">
                          {user?.primaryEmailAddress?.emailAddress || "Not provided"}
                        </p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Phone Number
                        </label>
                        <p className="text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">
                          {user?.phoneNumbers?.[0]?.phoneNumber ||
                            "Not provided"}
                        </p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          University
                        </label>
                        <p className="text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">
                          {(user?.publicMetadata?.university as string) ||
                            "Not set"}
                        </p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Nationality
                        </label>
                        <p className="text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">
                          {(user?.publicMetadata?.nationality as string) ||
                            "Not set"}
                        </p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          ESN Chapter
                        </label>
                        <p className="text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">
                          {(user?.publicMetadata?.chapter as string) ||
                            "Not set"}
                        </p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Telegram
                        </label>
                        <p className="text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">
                          {(user?.publicMetadata?.telegram as string) ||
                            "Not set"}
                        </p>
                      </div>
                    </div>

                    {/* Bio Section */}
                    {(user?.publicMetadata?.bio as string) && (
                      <div className="mb-6">
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Bio
                        </label>
                        <p className="text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">
                          {user?.publicMetadata?.bio as string}
                        </p>
                      </div>
                    )}

                    <div className="flex gap-3">
                      <Button
                        onClick={() => setIsEditingProfile(true)}
                        className="bg-blue-600 hover:bg-blue-700 text-white"
                      >
                        Edit Profile
                      </Button>
                      <Button
                        variant="outline"
                        className="border-gray-300 text-gray-700 hover:bg-gray-50"
                        onClick={handleExportData}
                      >
                        <DownloadIcon />
                        Export Data
                      </Button>
                    </div>
                  </Card>

                  {/* Recent Events Preview */}
                  <Card>
                    <div className="flex items-center justify-between mb-6">
                      <SectionHeader
                        icon={<CalendarIcon />}
                        title="Recent Events"
                      />
                      <div className="flex justify-end">
                        <Button
                          variant="outline"
                          onClick={() => setActiveTab("settings")}
                        >
                          Edit Profile
                        </Button>
                      </div>
                    </div>

                    {registrationsLoading ? (
                      <div className="space-y-3">
                        {[...Array(3)].map((_, i) => (
                          <div
                            key={i}
                            className="bg-gray-100 rounded-lg h-16 animate-pulse"
                          ></div>
                        ))}
                      </div>
                    ) : registrationsError ? (
                      <div className="text-center py-4">
                        <p className="text-red-500 mb-2">
                          Failed to load events
                        </p>
                        <Button
                          onClick={() => refetchRegistrations()}
                          variant="outline"
                          size="sm"
                        >
                          Try Again
                        </Button>
                      </div>
                    ) : allRegistrations.length === 0 ? (
                      <div className="text-center py-8">
                        <div className="text-4xl mb-4">ðŸ“…</div>
                        <p className="text-gray-500 mb-4">No events yet</p>
                        <Button
                          onClick={() => navigate("/events")}
                          className="bg-blue-600 hover:bg-blue-700 text-white"
                        >
                          Browse Events
                        </Button>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {allRegistrations
                          .slice(0, 3)
                          .map((registration: Registration) => (
                            <div
                              key={registration.id}
                              className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer"
                              onClick={() =>
                                navigate(`/events/${registration.event.id}`)
                              }
                            >
                              <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold">
                                  {new Date(
                                    registration.event.startDate
                                  ).getDate()}
                                </div>
                                <div>
                                  <h4 className="font-medium text-gray-900 line-clamp-1">
                                    {registration.event.title}
                                  </h4>
                                  <p className="text-xs text-gray-500">
                                    {new Date(
                                      registration.event.startDate
                                    ).toLocaleTimeString([], {
                                      hour: "2-digit",
                                      minute: "2-digit",
                                    })}
                                  </p>
                                </div>
                              </div>
                              <StatusBadge status={registration.status} />
                            </div>
                          ))}
                      </div>
                    )}
                  </Card>
                </div>

                {/* Right Column: ESN Card & Quick Actions */}
                <div className="lg:col-span-1 space-y-8">
                  {/* ESN Card Section */}
                  <div className="bg-white border border-gray-200 rounded-xl p-6">
                    <SectionHeader
                      icon={<CreditCardIcon />}
                      title="ESN Card"
                    />

                    {(user?.publicMetadata?.esnCardNumber as string) ? (
                      <div className="bg-gradient-to-r from-pink-500 to-purple-600 rounded-xl p-6 text-white shadow-lg relative overflow-hidden">
                        <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full"></div>
                        <div className="absolute bottom-0 left-0 -mb-4 -ml-4 w-20 h-20 bg-white opacity-10 rounded-full"></div>

                        <div className="flex justify-between items-start mb-8">
                          <div className="text-lg font-bold tracking-wider">
                            ESNcard
                          </div>
                          <div className="bg-white bg-opacity-20 px-2 py-1 rounded text-xs font-medium">
                            {(user?.publicMetadata?.esnCardVerified as boolean)
                              ? "Verified"
                              : "Pending Verification"}
                          </div>
                        </div>

                        <div className="mb-4">
                          <div className="text-xs opacity-75 mb-1">
                            Card Number
                          </div>
                          <div className="text-2xl font-mono tracking-widest">
                            {user?.publicMetadata?.esnCardNumber as string}
                          </div>
                        </div>

                        <div className="flex justify-between items-end">
                          <div>
                            <div className="text-xs opacity-75 mb-1">
                              Expiry
                            </div>
                            <div className="font-medium">
                              {(user?.publicMetadata?.esnCardExpiry as string) ||
                                "N/A"}
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="text-xs opacity-75 mb-1">
                              Holder
                            </div>
                            <div className="font-medium">
                              {user?.firstName} {user?.lastName}
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="bg-gray-50 rounded-xl p-6 text-center">
                        <div className="text-4xl mb-4">ðŸ’³</div>
                        <h4 className="text-lg font-medium text-gray-900 mb-2">
                          Add your ESNcard
                        </h4>
                        <p className="text-gray-600 mb-6 text-sm">
                          Link your ESNcard to get discounts and special access to
                          events.
                        </p>

                        <div className="space-y-4 max-w-xs mx-auto">
                          <Input
                            label="Card Number"
                            placeholder="Card Number (e.g. 123456789)"
                            value={esnCardNumber}
                            onChange={(e) => setEsnCardNumber(e.target.value)}
                          />
                          <Input
                            label="Expiry Date"
                            type="date"
                            placeholder="Expiry Date"
                            value={esnCardExpiry}
                            onChange={(e) => setEsnCardExpiry(e.target.value)}
                          />
                          <Button
                            onClick={handleEsnCardSubmit}
                            loading={isSubmittingCard}
                            className="w-full"
                          >
                            Link Card
                          </Button>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Right Column: Quick Actions & Stats */}
                  <div className="space-y-8">
                    {/* Stats Cards */}
                    <div className="grid grid-cols-2 lg:grid-cols-1 gap-4">
                      <div className="bg-white border border-gray-200 rounded-xl p-6">
                        <div className="text-gray-500 text-sm font-medium mb-1">
                          Events Attended
                        </div>
                        <div className="text-3xl font-bold text-gray-900">
                          {
                            allRegistrations.filter(
                              (r: Registration) => r.status === "ATTENDED"
                            ).length
                          }
                        </div>
                      </div>
                      <div className="bg-white border border-gray-200 rounded-xl p-6">
                        <div className="text-gray-500 text-sm font-medium mb-1">
                          Upcoming Events
                        </div>
                        <div className="text-3xl font-bold text-blue-600">
                          {
                            allRegistrations.filter(
                              (r: Registration) =>
                                new Date(r.event.startDate) > new Date() &&
                                r.status !== "CANCELLED"
                            ).length
                          }
                        </div>
                      </div>
                    </div>

                    {/* Quick Links */}
                    <div className="bg-white border border-gray-200 rounded-xl p-6">
                      <SectionHeader icon={<LinkIcon />} title="Quick Links" />
                      <div className="space-y-3">
                        <button
                          onClick={() => window.open(getCalendarLink(), "_blank")}
                          className="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors text-left"
                        >
                          <span className="font-medium text-gray-700">
                            Subscribe to Calendar
                          </span>
                          <svg
                            className="w-5 h-5 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                            />
                          </svg>
                        </button>
                        <button
                          onClick={() => navigate("/events")}
                          className="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors text-left"
                        >
                          <span className="font-medium text-gray-700">
                            Browse Events
                          </span>
                          <svg
                            className="w-5 h-5 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M9 5l7 7-7 7"
                            />
                          </svg>
                        </button>
                        <button
                          onClick={() => setActiveTab("settings")}
                          className="w-full flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors text-left"
                        >
                          <span className="font-medium text-gray-700">
                            Account Settings
                          </span>
                          <svg
                            className="w-5 h-5 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M9 5l7 7-7 7"
                            />
                          </svg>
                        </button>
                      </div>
                    </div>

                    {/* Support Card */}
                    <div className="bg-blue-50 border border-blue-100 rounded-xl p-6">
                      <h4 className="font-bold text-blue-900 mb-2">
                        Need Help?
                      </h4>
                      <p className="text-sm text-blue-700 mb-4">
                        Having trouble with your account or registrations? Contact
                        your ESN section for assistance.
                      </p>
                      <Button
                        variant="outline"
                        className="w-full border-blue-200 text-blue-700 hover:bg-blue-100"
                        onClick={() => window.location.href = "mailto:support@esn.org"}
                      >
                        Contact Support
                      </Button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Events Tab */}
            {activeTab === "events" && (
              <div className="space-y-6">
                <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                  <h2 className="text-2xl font-bold text-gray-900">
                    My Events
                  </h2>
                  <div className="flex bg-gray-100 p-1 rounded-lg">
                    {(["all", "upcoming", "past", "cancelled"] as const).map(
                      (filter) => (
                        <button
                          key={filter}
                          onClick={() => setEventFilter(filter)}
                          className={`px-4 py-2 rounded-md text-sm font-medium capitalize transition-all ${eventFilter === filter
                            ? "bg-white text-gray-900 shadow-sm"
                            : "text-gray-500 hover:text-gray-700"
                            }`}
                        >
                          {filter}
                        </button>
                      )
                    )}
                  </div>
                </div>

                {registrationsLoading ? (
                  <div className="space-y-4">
                    {[...Array(5)].map((_, i) => (
                      <div
                        key={i}
                        className="bg-white border border-gray-200 rounded-xl h-24 animate-pulse"
                      ></div>
                    ))}
                  </div>
                ) : registrations.length === 0 ? (
                  <div className="text-center py-12 bg-white border border-gray-200 rounded-xl">
                    <div className="text-5xl mb-4">ðŸŽ«</div>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">
                      No events found
                    </h3>
                    <p className="text-gray-500 mb-6">
                      {eventFilter === "all"
                        ? "You haven't registered for any events yet."
                        : `You don't have any ${eventFilter} events.`}
                    </p>
                    <Button
                      onClick={() => navigate("/events")}
                      className="bg-blue-600 hover:bg-blue-700 text-white"
                    >
                      Browse Events
                    </Button>
                  </div>
                ) : (
                  <div className="grid gap-4">
                    {registrations.map((registration: Registration) => (
                      <div
                        key={registration.id}
                        className="bg-white border border-gray-200 rounded-xl p-4 md:p-6 hover:shadow-md transition-shadow flex flex-col md:flex-row gap-6 items-start md:items-center"
                      >
                        <div className="flex-shrink-0 w-full md:w-24 h-24 bg-gray-100 rounded-lg overflow-hidden">
                          {registration.event.imageUrl ? (
                            <img
                              src={registration.event.imageUrl}
                              alt={registration.event.title}
                              className="w-full h-full object-cover"
                            />
                          ) : (
                            <div className="w-full h-full flex items-center justify-center text-gray-400">
                              <CalendarIcon />
                            </div>
                          )}
                        </div>

                        <div className="flex-grow space-y-2">
                          <div className="flex flex-col md:flex-row md:items-center justify-between gap-2">
                            <h3 className="text-lg font-bold text-gray-900">
                              {registration.event.title}
                            </h3>
                            <StatusBadge status={registration.status} />
                          </div>

                          <div className="flex flex-wrap gap-4 text-sm text-gray-600">
                            <div className="flex items-center">
                              <CalendarIcon />
                              {new Date(
                                registration.event.startDate
                              ).toLocaleDateString(undefined, {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                              })}
                            </div>
                            <div className="flex items-center">
                              <svg
                                className="w-5 h-5 mr-2 text-gray-400"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth={2}
                                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                              </svg>
                              {new Date(
                                registration.event.startDate
                              ).toLocaleTimeString(undefined, {
                                hour: "2-digit",
                                minute: "2-digit",
                              })}
                            </div>
                            <div className="flex items-center">
                              <svg
                                className="w-5 h-5 mr-2 text-gray-400"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth={2}
                                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                />
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth={2}
                                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                />
                              </svg>
                              {registration.event.location}
                            </div>
                          </div>
                        </div>

                        <div className="flex-shrink-0 flex gap-2 w-full md:w-auto">
                          <Button
                            variant="outline"
                            className="flex-1 md:flex-none"
                            onClick={() =>
                              navigate(`/events/${registration.event.id}`)
                            }
                          >
                            View Details
                          </Button>
                          {registration.status !== "CANCELLED" &&
                            new Date(registration.event.startDate) >
                            new Date() && (
                              <Button
                                variant="outline"
                                className="flex-1 md:flex-none text-red-600 border-red-200 hover:bg-red-50"
                                onClick={async () => {
                                  if (
                                    window.confirm(
                                      "Are you sure you want to cancel your registration?"
                                    )
                                  ) {
                                    try {
                                      await cancelRegistration(registration.id);
                                      setUpdateSuccess(true);
                                      setTimeout(() => setUpdateSuccess(false), 3000);
                                      refetchRegistrations();
                                    } catch (error) {
                                      console.error('Cancel registration error:', error);
                                      setUpdateError('Failed to cancel registration. Please try again.');
                                    }
                                  }
                                }}
                              >
                                Cancel
                              </Button>
                            )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Settings Tab */}
            {activeTab === "settings" && (
              <div className="max-w-4xl space-y-8">
                {/* Account Settings */}
                <div className="bg-white border border-gray-200 rounded-xl p-6">
                  <SectionHeader
                    icon={<SettingsIcon />}
                    title="Account Settings"
                  />

                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <h4 className="font-semibold text-gray-900 mb-2">
                        Change Password
                      </h4>
                      <p className="text-sm text-gray-600 mb-4">
                        Update your password to keep your account secure.
                      </p>
                      <Button
                        variant="outline"
                        className="w-full justify-center"
                        onClick={() => {
                          // Clerk handles password change via their UI or a specific flow
                          // For now, we can redirect to Clerk's user profile or show a message
                          alert("Please use the Clerk User Button in the navbar to manage your account security.");
                        }}
                      >
                        Change Password
                      </Button>
                    </div>
                  </div>
                </div>

                {/* Privacy & Visibility */}
                <div className="bg-white border border-gray-200 rounded-xl p-6">
                  <div className="flex items-center justify-between mb-6">
                    <SectionHeader
                      icon={<ShieldIcon />}
                      title="Privacy & Visibility"
                    />
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setShowPrivacySettings(true)}
                    >
                      <EyeIcon />
                      Manage
                    </Button>
                  </div>

                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Profile visible to others
                        </span>
                        <span
                          className={`text-sm font-medium ${privacy.profileVisible
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {privacy.profileVisible ? "Public" : "Private"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Show email address
                        </span>
                        <span
                          className={`text-sm font-medium ${privacy.showEmail
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {privacy.showEmail ? "Visible" : "Hidden"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Show phone number
                        </span>
                        <span
                          className={`text-sm font-medium ${privacy.showPhone
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {privacy.showPhone ? "Visible" : "Hidden"}
                        </span>
                      </div>
                    </div>
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Show university
                        </span>
                        <span
                          className={`text-sm font-medium ${privacy.showUniversity
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {privacy.showUniversity ? "Visible" : "Hidden"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Allow messages from others
                        </span>
                        <span
                          className={`text-sm font-medium ${privacy.allowMessages
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {privacy.allowMessages ? "Enabled" : "Disabled"}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Notification Settings */}
                <div className="bg-white border border-gray-200 rounded-xl p-6">
                  <div className="flex items-center justify-between mb-6">
                    <SectionHeader
                      icon={<BellIcon />}
                      title="Notification Settings"
                    />
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setShowNotificationSettings(true)}
                    >
                      Manage
                    </Button>
                  </div>

                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Event notifications
                        </span>
                        <span
                          className={`text-sm font-medium ${notifications.emailEvents
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {notifications.emailEvents ? "On" : "Off"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Event reminders
                        </span>
                        <span
                          className={`text-sm font-medium ${notifications.emailReminders
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {notifications.emailReminders ? "On" : "Off"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Newsletter
                        </span>
                        <span
                          className={`text-sm font-medium ${notifications.emailNewsletter
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {notifications.emailNewsletter ? "On" : "Off"}
                        </span>
                      </div>
                    </div>
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          Push notifications
                        </span>
                        <span
                          className={`text-sm font-medium ${notifications.pushEvents
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {notifications.pushEvents ? "On" : "Off"}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          SMS reminders
                        </span>
                        <span
                          className={`text-sm font-medium ${notifications.smsReminders
                            ? "text-green-600"
                            : "text-gray-500"
                            }`}
                        >
                          {notifications.smsReminders ? "On" : "Off"}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Data & Calendar */}
                <div className="bg-white border border-gray-200 rounded-xl p-6">
                  <SectionHeader
                    icon={<LinkIcon />}
                    title="Data & Integrations"
                  />

                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <h4 className="font-semibold text-gray-900 mb-2">
                        Export Your Data
                      </h4>
                      <p className="text-sm text-gray-600 mb-4">
                        Download all your data in JSON format.
                      </p>
                      <Button variant="outline" onClick={handleExportData}>
                        <DownloadIcon />
                        Export Data
                      </Button>
                    </div>

                    <div>
                      <h4 className="font-semibold text-gray-900 mb-2">
                        Calendar Integration
                      </h4>
                      <p className="text-sm text-gray-600 mb-4">
                        Subscribe to your personal event calendar.
                      </p>
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <input
                            type="text"
                            value={getCalendarLink()}
                            readOnly
                            className="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded text-sm"
                          />
                          <Button
                            size="sm"
                            onClick={() => {
                              navigator.clipboard.writeText(getCalendarLink());
                              setUpdateSuccess(true);
                              setTimeout(() => setUpdateSuccess(false), 2000);
                            }}
                          >
                            Copy
                          </Button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Danger Zone */}
                <div className="bg-red-50 border border-red-200 rounded-xl p-6">


                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="font-medium text-red-900">Sign Out</h4>
                        <p className="text-sm text-red-700">
                          Sign out of your account on this device.
                        </p>
                      </div>
                      <Button
                        variant="outline"
                        className="border-red-300 text-red-700 hover:bg-red-100"
                        onClick={handleLogout}
                      >
                        Sign Out
                      </Button>
                    </div>

                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="font-medium text-red-900">
                          Delete Account
                        </h4>
                        <p className="text-sm text-red-700">
                          Permanently delete your account and all data.
                        </p>
                      </div>
                      <Button
                        variant="outline"
                        className="border-red-300 text-red-700 hover:bg-red-100"
                        onClick={() => setShowDeleteAccount(true)}
                      >
                        Delete Account
                      </Button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div >

      {/* Edit Profile Modal */}
      {
        isEditingProfile && (
          <div className="fixed inset-0 z-50 overflow-y-auto">
            <div
              className="fixed inset-0 bg-black bg-opacity-50"
              onClick={() => setIsEditingProfile(false)}
            ></div>
            <div className="flex min-h-screen items-center justify-center p-4">
              <div className="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-2xl">
                  <div className="flex items-center justify-between">
                    <h3 className="text-xl font-bold text-gray-900">
                      Edit Profile
                    </h3>
                    <button
                      onClick={() => setIsEditingProfile(false)}
                      className="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                      <svg
                        className="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </div>
                </div>

                <form onSubmit={handleProfileUpdate} className="p-6 space-y-6">
                  <div className="grid md:grid-cols-2 gap-4">
                    <Input
                      label="First Name"
                      value={profileData.firstName}
                      onChange={(e) =>
                        setProfileData({
                          ...profileData,
                          firstName: e.target.value,
                        })
                      }
                      required
                    />
                    <Input
                      label="Last Name"
                      value={profileData.lastName}
                      onChange={(e) =>
                        setProfileData({
                          ...profileData,
                          lastName: e.target.value,
                        })
                      }
                      required
                    />
                  </div>

                  <div className="grid md:grid-cols-2 gap-4">
                    <Input
                      label="Phone Number"
                      value={profileData.phone}
                      onChange={(e) =>
                        setProfileData({ ...profileData, phone: e.target.value })
                      }
                      placeholder="+49 123 456 7890"
                    />
                    <Input
                      label="University"
                      value={profileData.university}
                      onChange={(e) =>
                        setProfileData({
                          ...profileData,
                          university: e.target.value,
                        })
                      }
                      placeholder="Your university"
                    />
                  </div>

                  <div className="grid md:grid-cols-2 gap-4">
                    <Input
                      label="Nationality"
                      value={profileData.nationality}
                      onChange={(e) =>
                        setProfileData({
                          ...profileData,
                          nationality: e.target.value,
                        })
                      }
                      placeholder="Your nationality"
                    />
                    <Input
                      label="ESN Chapter"
                      value={profileData.chapter}
                      onChange={(e) =>
                        setProfileData({
                          ...profileData,
                          chapter: e.target.value,
                        })
                      }
                      placeholder="ESN Chapter name"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Bio
                    </label>
                    <textarea
                      value={profileData.bio}
                      onChange={(e) =>
                        setProfileData({ ...profileData, bio: e.target.value })
                      }
                      placeholder="Tell us about yourself..."
                      rows={3}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>

                  <div className="grid md:grid-cols-2 gap-4">
                    <Input
                      label="Telegram Username"
                      value={profileData.telegram}
                      onChange={(e) =>
                        setProfileData({
                          ...profileData,
                          telegram: e.target.value,
                        })
                      }
                      placeholder="@username"
                    />
                    <Input
                      label="Instagram Handle"
                      value={profileData.instagram}
                      onChange={(e) =>
                        setProfileData({
                          ...profileData,
                          instagram: e.target.value,
                        })
                      }
                      placeholder="@username"
                    />
                  </div>

                  <div className="border-t border-gray-200 pt-6">
                    <h4 className="font-medium text-gray-900 mb-4">
                      Emergency Contact
                    </h4>
                    <div className="grid md:grid-cols-2 gap-4">
                      <Input
                        label="Contact Name"
                        value={profileData.emergencyContactName}
                        onChange={(e) =>
                          setProfileData({
                            ...profileData,
                            emergencyContactName: e.target.value,
                          })
                        }
                        placeholder="Full name"
                      />
                      <Input
                        label="Contact Phone"
                        value={profileData.emergencyContactPhone}
                        onChange={(e) =>
                          setProfileData({
                            ...profileData,
                            emergencyContactPhone: e.target.value,
                          })
                        }
                        placeholder="+49 123 456 7890"
                      />
                    </div>
                  </div>

                  <div className="flex gap-3 pt-4 border-t border-gray-200">
                    <Button
                      type="submit"
                      className="flex-1 bg-blue-600 hover:bg-blue-700"
                      loading={updating}
                      disabled={
                        !profileData.firstName ||
                        !profileData.lastName ||
                        updating
                      }
                    >
                      {updating ? "Saving..." : "Save Changes"}
                    </Button>
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => {
                        setIsEditingProfile(false);
                        // Reset form data
                        setProfileData({
                          firstName: user?.firstName || "",
                          lastName: user?.lastName || "",
                          phone: user?.phoneNumbers?.[0]?.phoneNumber || "",
                          university:
                            (user?.publicMetadata?.university as string) || "",
                          nationality:
                            (user?.publicMetadata?.nationality as string) || "",
                          chapter:
                            (user?.publicMetadata?.chapter as string) || "",
                          bio: (user?.publicMetadata?.bio as string) || "",
                          telegram:
                            (user?.publicMetadata?.telegram as string) || "",
                          instagram:
                            (user?.publicMetadata?.instagram as string) || "",
                          emergencyContactName:
                            (user?.publicMetadata
                              ?.emergencyContactName as string) || "",
                          emergencyContactPhone:
                            (user?.publicMetadata
                              ?.emergencyContactPhone as string) || "",
                        });
                      }}
                      className="flex-1"
                    >
                      Cancel
                    </Button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        )
      }

      {/* Change Photo Modal */}
      {
        isChangingPhoto && (
          <div className="fixed inset-0 z-50 overflow-y-auto">
            <div
              className="fixed inset-0 bg-black bg-opacity-50"
              onClick={() => setIsChangingPhoto(false)}
            ></div>
            <div className="flex min-h-screen items-center justify-center p-4">
              <div className="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-xl font-bold text-gray-900">
                    Change Profile Photo
                  </h3>
                  <button
                    onClick={() => setIsChangingPhoto(false)}
                    className="text-gray-400 hover:text-gray-600 transition-colors"
                  >
                    <svg
                      className="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>

                <div className="space-y-4">
                  <div className="text-center">
                    <div className="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center overflow-hidden mb-4">
                      {user?.imageUrl ? (
                        <img
                          src={user.imageUrl}
                          alt="Current profile"
                          className="w-full h-full object-cover"
                        />
                      ) : (
                        <span className="text-2xl font-bold text-gray-500">
                          {user?.firstName?.[0]?.toUpperCase() || "U"}
                        </span>
                      )}
                    </div>
                  </div>

                  <div
                    className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer"
                    onClick={() =>
                      document.getElementById("photo-upload")?.click()
                    }
                  >
                    <CloudUploadIcon />
                    <p className="text-sm text-gray-600">
                      Click to upload or drag and drop
                    </p>
                    <p className="text-xs text-gray-500 mt-1">
                      PNG, JPG up to 10MB
                    </p>
                  </div>

                  <input
                    id="photo-upload"
                    type="file"
                    accept="image/*"
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (file) {
                        handlePhotoUpload(file);
                      }
                    }}
                    className="hidden"
                  />

                  <div className="flex gap-3">
                    <Button
                      variant="outline"
                      onClick={() => setIsChangingPhoto(false)}
                      className="flex-1"
                      disabled={isUploadingPhoto}
                    >
                      Cancel
                    </Button>
                    <Button
                      onClick={() =>
                        document.getElementById("photo-upload")?.click()
                      }
                      className="flex-1"
                      loading={isUploadingPhoto}
                      disabled={isUploadingPhoto}
                    >
                      {isUploadingPhoto ? "Uploading..." : "Choose File"}
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      }

      {/* Notification Settings Modal */}
      {
        showNotificationSettings && (
          <div className="fixed inset-0 z-50 overflow-y-auto">
            <div
              className="fixed inset-0 bg-black bg-opacity-50"
              onClick={() => setShowNotificationSettings(false)}
            ></div>
            <div className="flex min-h-screen items-center justify-center p-4">
              <div className="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-xl font-bold text-gray-900">
                    Notification Settings
                  </h3>
                  <button
                    onClick={() => setShowNotificationSettings(false)}
                    className="text-gray-400 hover:text-gray-600 transition-colors"
                  >
                    <svg
                      className="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>

                <div className="space-y-6">
                  <div>
                    <h4 className="font-medium text-gray-900 mb-3">
                      Email Notifications
                    </h4>
                    <div className="space-y-3">
                      {[
                        { key: "emailEvents", label: "New events" },
                        { key: "emailReminders", label: "Event reminders" },
                        { key: "emailNewsletter", label: "Newsletter" },
                        { key: "emailPromotions", label: "Promotions" },
                      ].map(({ key, label }) => (
                        <div
                          key={key}
                          className="flex items-center justify-between"
                        >
                          <span className="text-sm text-gray-700">{label}</span>
                          <label className="relative inline-flex items-center cursor-pointer">
                            <input
                              type="checkbox"
                              checked={
                                notifications[key as keyof NotificationSettings]
                              }
                              onChange={(e) =>
                                setNotifications({
                                  ...notifications,
                                  [key]: e.target.checked,
                                })
                              }
                              className="sr-only peer"
                            />
                            <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                          </label>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h4 className="font-medium text-gray-900 mb-3">
                      Push Notifications
                    </h4>
                    <div className="space-y-3">
                      {[
                        { key: "pushEvents", label: "New events" },
                        { key: "pushReminders", label: "Event reminders" },
                        { key: "pushUpdates", label: "System updates" },
                      ].map(({ key, label }) => (
                        <div
                          key={key}
                          className="flex items-center justify-between"
                        >
                          <span className="text-sm text-gray-700">{label}</span>
                          <label className="relative inline-flex items-center cursor-pointer">
                            <input
                              type="checkbox"
                              checked={
                                notifications[key as keyof NotificationSettings]
                              }
                              onChange={(e) =>
                                setNotifications({
                                  ...notifications,
                                  [key]: e.target.checked,
                                })
                              }
                              className="sr-only peer"
                            />
                            <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                          </label>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h4 className="font-medium text-gray-900 mb-3">SMS</h4>
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-700">
                          SMS reminders
                        </span>
                        <label className="relative inline-flex items-center cursor-pointer">
                          <input
                            type="checkbox"
                            checked={notifications.smsReminders}
                            onChange={(e) =>
                              setNotifications({
                                ...notifications,
                                smsReminders: e.target.checked,
                              })
                            }
                            className="sr-only peer"
                          />
                          <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div className="flex gap-3 pt-4 border-t border-gray-200">
                    <Button
                      onClick={handleNotificationUpdate}
                      className="flex-1 bg-blue-600 hover:bg-blue-700"
                    >
                      Save Settings
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => setShowNotificationSettings(false)}
                      className="flex-1"
                    >
                      Cancel
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      }

      {/* Privacy Settings Modal */}
      {
        showPrivacySettings && (
          <div className="fixed inset-0 z-50 overflow-y-auto">
            <div
              className="fixed inset-0 bg-black bg-opacity-50"
              onClick={() => setShowPrivacySettings(false)}
            ></div>
            <div className="flex min-h-screen items-center justify-center p-4">
              <div className="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-xl font-bold text-gray-900">
                    Privacy Settings
                  </h3>
                  <button
                    onClick={() => setShowPrivacySettings(false)}
                    className="text-gray-400 hover:text-gray-600 transition-colors"
                  >
                    <svg
                      className="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>

                <div className="space-y-6">
                  <div>
                    <h4 className="font-medium text-gray-900 mb-3">
                      Profile Visibility
                    </h4>
                    <div className="space-y-3">
                      {[
                        {
                          key: "profileVisible",
                          label: "Profile visible to other members",
                        },
                        { key: "showEmail", label: "Show email address" },
                        { key: "showPhone", label: "Show phone number" },
                        { key: "showUniversity", label: "Show university" },
                        {
                          key: "allowMessages",
                          label: "Allow messages from other members",
                        },
                      ].map(({ key, label }) => (
                        <div
                          key={key}
                          className="flex items-center justify-between"
                        >
                          <span className="text-sm text-gray-700">{label}</span>
                          <label className="relative inline-flex items-center cursor-pointer">
                            <input
                              type="checkbox"
                              checked={privacy[key as keyof PrivacySettings]}
                              onChange={(e) =>
                                setPrivacy({
                                  ...privacy,
                                  [key]: e.target.checked,
                                })
                              }
                              className="sr-only peer"
                            />
                            <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                          </label>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="bg-blue-50 p-4 rounded-lg">
                    <p className="text-sm text-blue-800">
                      <strong>Note:</strong> Even with privacy settings enabled,
                      event organizers and admins may still be able to view your
                      contact information for event management purposes.
                    </p>
                  </div>

                  <div className="flex gap-3 pt-4 border-t border-gray-200">
                    <Button
                      onClick={handlePrivacyUpdate}
                      className="flex-1 bg-blue-600 hover:bg-blue-700"
                    >
                      Save Settings
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => setShowPrivacySettings(false)}
                      className="flex-1"
                    >
                      Cancel
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      }

      {/* Delete Account Confirmation Modal */}
      {
        showDeleteAccount && (
          <div className="fixed inset-0 z-50 overflow-y-auto">
            <div
              className="fixed inset-0 bg-black bg-opacity-50"
              onClick={() => setShowDeleteAccount(false)}
            ></div>
            <div className="flex min-h-screen items-center justify-center p-4">
              <div className="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div className="text-center">
                  <div className="text-6xl mb-4">âš ï¸</div>
                  <h3 className="text-xl font-bold text-red-900 mb-2">
                    Delete Account
                  </h3>
                  <p className="text-gray-600 mb-6">
                    This action cannot be undone. This will permanently delete
                    your account and remove all your data from our servers.
                  </p>

                  <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <h4 className="font-medium text-red-900 mb-2">
                      What will be deleted:
                    </h4>
                    <ul className="text-sm text-red-800 text-left space-y-1">
                      <li>â€¢ Your profile and personal information</li>
                      <li>â€¢ All event registrations and history</li>
                      <li>â€¢ Payment records and receipts</li>
                      <li>â€¢ ESN card information</li>
                      <li>â€¢ Notification and privacy preferences</li>
                    </ul>
                  </div>

                  <div className="flex gap-3">
                    <Button
                      variant="outline"
                      onClick={() => setShowDeleteAccount(false)}
                      className="flex-1"
                    >
                      Cancel
                    </Button>
                    <Button
                      onClick={handleDeleteAccount}
                      className="flex-1 bg-red-600 hover:bg-red-700 text-white"
                    >
                      Delete Account
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      }
    </div >
  );
};

export default ProfilePage;