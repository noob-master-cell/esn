// backend/prisma/schema.prisma
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// USER MANAGEMENT
// ================================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Auth Integration - supporting both Clerk (legacy) and Auth0
  clerkId   String?  @unique  // Made optional for migration
  auth0Id   String?  @unique  // New Auth0 user ID

  // Basic Info
  email     String  @unique
  firstName String?
  lastName  String?
  avatar    String?
  phone     String?

  // ESN Specific
  esnCardNumber   String?  @unique
  esnCardVerified Boolean  @default(false)
  esnCardExpiry   DateTime?
  university      String?
  chapter         String?
  nationality     String?
  bio             String?
  telegram        String?
  instagram       String?
  emergencyContactName String?
  emergencyContactPhone String?

  // Account Status
  emailVerified Boolean @default(false)
  isActive      Boolean @default(true)
  role          UserRole @default(USER)

  // Preferences

  preferences   UserPreferences?

  // Relations
  registrations Registration[]
  payments      Payment[]
  reviews       Review[]
  feedbacks     Feedback[]
  comments      Comment[]
  createdEvents Event[] @relation("EventCreator")

  @@map("users")
  @@index([createdAt])
  @@index([role])
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)



  // Language and display
  language String @default("en")
  timezone String @default("UTC")

  @@map("user_preferences")
}



// ================================
// EVENT MANAGEMENT
// ================================

model Event {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Basic Info
  title       String
  description String
  shortDescription String?
  
  // Event Details
  category    EventCategory
  type        EventType
  status      EventStatus @default(DRAFT)
  
  // Dates
  startDate   DateTime
  endDate     DateTime
  registrationDeadline DateTime?
  
  // Location
  location    String
  address     String?
  
  // Capacity
  maxParticipants Int
  
  // Pricing
  price       Float?
  memberPrice Float?
  
  // Media & Info
  images      String[] @default([])
  tags        String[]
  requirements String?
  additionalInfo String?
  
  // Settings
  isPublic     Boolean @default(true)
  isUnlimited  Boolean @default(false)

  
  // Relations - Only ADMIN can create events
  organizer    User     @relation("EventCreator", fields: [organizerId], references: [id])
  organizerId  String
  
  registrations Registration[]
  reviews      Review[]
  comments     Comment[]
  payments     Payment[]

  @@map("events")
  @@index([createdAt])
  @@index([startDate])
  @@index([status, isPublic, startDate])
  @@index([organizerId])
  @@index([category])
  @@index([type])
  // Compound indexes for optimized query patterns
  @@index([category, startDate, status])  // Category browsing with date filtering
  @@index([type, status, startDate])      // Free/paid event filtering
  @@index([organizerId, status, startDate]) // Admin "my events" view
  @@index([location, startDate])          // Location-based event search
}

// ================================
// REGISTRATION SYSTEM
// ================================

model Registration {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Registration Details
  status          RegistrationStatus @default(PENDING)
  registrationType RegistrationType  @default(REGULAR)
  position        Int?               // Position in waitlist if applicable
  
  // Payment
  paymentRequired Boolean @default(false)
  paymentStatus   PaymentStatus @default(PENDING)
  amountDue       Decimal @default(0)
  currency        String @default("EUR")

  // Additional Info
  specialRequests String?
  emergencyContact String?
  dietary         String?
  
  // Timestamps
  registeredAt DateTime @default(now())
  confirmedAt  DateTime?
  cancelledAt  DateTime?

  // Relations
  payments Payment[]

  @@unique([userId, eventId])
  @@index([eventId, status])
  @@index([registeredAt])
  @@index([userId])
  @@index([paymentStatus])
  // Compound indexes for optimized query patterns
  @@index([userId, status, registeredAt])  // User's registration history
  @@index([eventId, paymentStatus])        // Event payment tracking
  @@map("registrations")
}

// ================================
// PAYMENT SYSTEM
// ================================

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  eventId        String
  event          Event        @relation(fields: [eventId], references: [id])
  registrationId String
  registration   Registration @relation(fields: [registrationId], references: [id])

  // Payment Details
  amount         Decimal
  currency       String        @default("EUR")
  status         PaymentStatus @default(PENDING)
  method         PaymentMethod @default(CASH)



  // Metadata
  description    String?
  refundAmount   Decimal @default(0)
  refundedAt     DateTime?
  failureReason  String?

  @@map("payments")
  @@index([createdAt])
  @@index([status])
  @@index([userId])
  @@index([eventId])
}

// ================================
// REVIEW SYSTEM
// ================================

model Review {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Review Content
  rating  Int    // 1-5 stars
  title   String?
  comment String?

  // Moderation
  isPublic  Boolean @default(true)
  isVerified Boolean @default(false) // Only users who attended can review

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@map("reviews")
}

// ================================
// ENUMS - SIMPLIFIED
// ================================

enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

enum EventStatus {
  DRAFT
  PUBLISHED
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  ONGOING
  COMPLETED
  CANCELLED
}

enum EventCategory {
  SOCIAL
  CULTURAL
  EDUCATIONAL
  SPORTS
  TRAVEL
  VOLUNTEER
  NETWORKING
  PARTY
  WORKSHOP
  CONFERENCE
  OTHER
}

enum EventType {
  FREE
  PAID
  MEMBERS_ONLY
}

enum RegistrationStatus {
  PENDING
  CONFIRMED

  CANCELLED
  ATTENDED
  NO_SHOW
  WAITLIST
}

enum RegistrationType {
  REGULAR

  VIP
  ORGANIZER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {

  CASH
  BANK_TRANSFER
  FREE
}

// ================================
// FEEDBACK SYSTEM
// ================================

model Feedback {
  id        String       @id @default(cuid())
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Content
  message   String
  type      FeedbackType @default(FEEDBACK)

  // Relations
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("feedbacks")
  @@index([createdAt])
  @@index([userId])
}

enum FeedbackType {
  BUG
  FEEDBACK
  IMPROVEMENT
}

// ================================
// COMMENT SYSTEM
// ================================

model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  content   String

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([userId])
  @@map("comments")
}